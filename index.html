<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Sudoku</title>
	<script type="module">
		import * as wasm from "./build/release.js";

		/**
		 * Extracts the 2D array of numbers of the Sudoku field from the HTML table.
		 */
		function getField() {
			const field = [];
			for (let y = 0; y < 9; y++) {
				const row = [];
				for (let x = 0; x < 9; x++) {
					// Since we only have td elements in the table, we can get the n-th td element
					const cellOffset = (y * 9) + x
					const cellDom = document.getElementsByTagName("td")[cellOffset]
					let cellValue = cellDom.innerText
					cellValue = (cellValue === "" || cellValue === "-" || cellValue == "_")? 0 : parseInt(cellValue)
					row.push(cellValue)
				}
				field.push(row);
			}
			return field;
		}

		/**
		 * Writes the 2D array of numbers into the Sudoku field in the HTML table.
		 */
		function setField(field) {
			for (let y = 0; y < 9; y++) {
				for (let x = 0; x < 9; x++) {
					const cellOffset = (y * 9) + x
					const cellValue = field[y][x]
					const cellDom = document.getElementsByTagName("td")[cellOffset]
					cellDom.innerText = (cellValue !== 0)? cellValue : ""
				}
			}
		}

		/**
		 * Gets the sudoku field from the HTML DOM, solves it using the WASM module
		 * and writes the result back to the DOM.
		 */
		function solveSudoku() {
			const inputField = getField()
			console.log({ inputField })

			// Check whether the input field is valid and show an error message if not
			const isValid = wasm.isSudokuValid(inputField)
			if (!isValid) {
				alert("Invalid Sudoku")
			}

			// Solve the Sudoku and measure the time it took
			const startTime = performance.now()
			const sudokuResult = wasm.solveSudoku(inputField)
			const endTime = performance.now()

			// Show result statistics
			document.getElementById("result").innerText = `Success: ${sudokuResult.success}\n`
				+ `Tried Permutations: ${new Intl.NumberFormat().format(sudokuResult.tries)}\n`
				+ `Time: ${endTime - startTime}ms`
			

			console.log(sudokuResult)

			// Update the HTML table with the result
			setField(sudokuResult.field)
		}
		
		/**
		 * Gets called when the user clicks the "Solve" button
		 */
		document.getElementById("solve").addEventListener("click", () => {
			try {
				solveSudoku()
			} catch (e) {
				alert("Error: " + e)
			}
		});

		document.getElementById("clear").addEventListener("click", () => {
			try {
				setField([
					[0, 0, 0,	0, 0, 0,	0, 0, 0],
					[0, 0, 0,	0, 0, 0,	0, 0, 0],
					[0, 0, 0,	0, 0, 0,	0, 0, 0],

					[0, 0, 0,	0, 0, 0,	0, 0, 0],
					[0, 0, 0,	0, 0, 0,	0, 0, 0],
					[0, 0, 0,	0, 0, 0,	0, 0, 0],

					[0, 0, 0,	0, 0, 0,	0, 0, 0],
					[0, 0, 0,	0, 0, 0,	0, 0, 0],
					[0, 0, 0,	0, 0, 0,	0, 0, 0],
				])
			} catch (e) {
				alert("Error: " + e)
			}
		})
	</script>

	<style>
		table, td {
			border: 1px solid black;
			border-collapse: collapse;
		}
		td {
			width: 30px;
			height: 30px;
			font-size: larger;
			text-align: center;
		}
		button {
			padding: 10px;
			margin: 10px 0;
			color: white;
			border: none;
			cursor: pointer;
			border-radius: 5px;
		}
	</style>
</head>
<body>
	<h1 style="margin-bottom: 0;">Sudoku Solver</h1>
	<p style="margin-top: 0;"><i>in AssemblyScript/WebAssembly</i></p>

	<p id="result"></p>

	<table>
		<tr>
			<td contentEditable="true"></td><td contentEditable="true"></td><td contentEditable="true"></td> <td contentEditable="true"></td><td contentEditable="true"></td><td contentEditable="true">2</td> <td contentEditable="true"></td><td contentEditable="true"></td><td contentEditable="true"></td>
		</tr>
		<tr>
			<td contentEditable="true"></td><td contentEditable="true">6</td><td contentEditable="true">2</td> <td contentEditable="true"></td><td contentEditable="true"></td><td contentEditable="true"></td> <td contentEditable="true">5</td><td contentEditable="true"></td><td contentEditable="true">4</td>
		</tr>
		<tr>
			<td contentEditable="true">9</td><td contentEditable="true">5</td><td contentEditable="true">1</td> <td contentEditable="true">7</td><td contentEditable="true"></td><td contentEditable="true">4</td> <td contentEditable="true">6</td><td contentEditable="true">2</td><td contentEditable="true"></td>
		</tr>

		<tr>
			<td contentEditable="true"></td><td contentEditable="true"></td><td contentEditable="true"></td> <td contentEditable="true">4</td><td contentEditable="true"></td><td contentEditable="true">9</td> <td contentEditable="true"></td><td contentEditable="true">8</td><td contentEditable="true">3</td>
		</tr>
		<tr>
			<td contentEditable="true">7</td><td contentEditable="true">8</td><td contentEditable="true">6</td> <td contentEditable="true"></td><td contentEditable="true">2</td><td contentEditable="true">3</td> <td contentEditable="true"></td><td contentEditable="true"></td><td contentEditable="true"></td>
		</tr>
		<tr>
			<td contentEditable="true"></td><td contentEditable="true"></td><td contentEditable="true"></td> <td contentEditable="true"></td><td contentEditable="true"></td><td contentEditable="true"></td> <td contentEditable="true">2</td><td contentEditable="true">1</td><td contentEditable="true">6</td>
		</tr>

		<tr>
			<td contentEditable="true">5</td><td contentEditable="true"></td><td contentEditable="true">3</td> <td contentEditable="true"></td><td contentEditable="true">8</td><td contentEditable="true">7</td> <td contentEditable="true"></td><td contentEditable="true">6</td><td contentEditable="true"></td>
		</tr>
		<tr>
			<td contentEditable="true"></td><td contentEditable="true"></td><td contentEditable="true"></td> <td contentEditable="true"></td><td contentEditable="true"></td><td contentEditable="true">5</td> <td contentEditable="true"></td><td contentEditable="true">3</td><td contentEditable="true">7</td>
		</tr>
		<tr>
			<td contentEditable="true">2</td><td contentEditable="true"></td><td contentEditable="true">7</td> <td contentEditable="true"></td><td contentEditable="true">1</td><td contentEditable="true">6</td> <td contentEditable="true"></td><td contentEditable="true">5</td><td contentEditable="true"></td>
		</tr>
	</table>

	<button id="solve" style="background-color: dodgerblue;">Solve</button>
	<button id="clear" style="background-color: red;">Clear</button>

	<br><br>

	<small>
		Software licensed under <i>AGPL-3.0-or-later</i> (SPDX).<br>
		Source code available at <a href="https://github.com/linuskmr/sudoku-wasm">github.com/linuskmr/sudoku-wasm</a>.
	</small>
</body>
</html>
